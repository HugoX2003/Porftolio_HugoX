---
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";

import plenamenteImg from "../assets/plenamente.webp";
import caridImg from "../assets/carid.webp";
import financetrackerImg from "../assets/financetracker.webp";
import nisiraassistantImg from "../assets/nisiraassistant.webp";

const projects = [
    {
        title: "PLENAMENTE",
        description:
            "Landing page developed with Astro and a frontend web application built with Angular. An integrated system for managing appointments and psychological resources.",
        tech: [
            "simple-icons:astro",
            "simple-icons:angular",
            "mdi:language-typescript",
            "simple-icons:netlify",
        ],
        type: "FULLSTACK / WEB",
        image: plenamenteImg,
        links: [
            {
                label: "LANDING_REPO",
                url: "https://github.com/Sauro-Dev/landing-plenamente",
                icon: "mdi:github",
            },
            {
                label: "FRONT_REPO",
                url: "https://github.com/Sauro-Dev/PLENA-APP-FRONT/tree/main",
                icon: "mdi:github",
            },
            {
                label: "LIVE_DEMO",
                url: "https://plenamente.netlify.app/",
                icon: "mdi:web",
            },
        ],
    },
    {
        title: "CARID_SYSTEM",
        description:
            "Vehicle License Plate Identification System. Collaborative project involving planning, frontend development, and detection model training.",
        tech: ["mdi:language-python", "simple-icons:tensorflow", "mdi:web"],
        type: "AI / WEB",
        image: caridImg,
        links: [
            {
                label: "FRONT_REPO",
                url: "https://github.com/GRUPO-PERCEPCION/carid-frontend",
                icon: "mdi:github",
            },
            {
                label: "BACK_REPO",
                url: "https://github.com/GRUPO-PERCEPCION/CARID_PROJECT",
                icon: "mdi:github",
            },
        ],
    },
    {
        title: "FINANCETRACKER",
        description:
            "SME finance control mobile application. Native Android development with Kotlin and UI/UX design in Figma.",
        tech: ["mdi:language-kotlin", "mdi:android", "simple-icons:figma"],
        type: "MOBILE / DESIGN",
        image: financetrackerImg,
        links: [
            {
                label: "APP_REPO",
                url: "https://github.com/FinanceTrackerAP/FinanceTracker",
                icon: "mdi:github",
            },
            {
                label: "FIGMA_DESIGN",
                url: "https://www.figma.com/design/q5zsFAdIfDEZc7jixQSeiC/FinanceTracker?node-id=0-1&t=tfNRyV8ZA4j7WPgz-1",
                icon: "simple-icons:figma",
            },
        ],
    },
    {
        title: "NISIRA_ASSISTANT",
        description:
            "Intelligent RAG-based conversational assistant for document retrieval at NISIRA. Built with Django, React, and ChromaDB.",
        tech: [
            "simple-icons:googlegemini",
            "mdi:file-document-outline",
            "mdi:brain",
        ],
        type: "AI / THESIS",
        image: nisiraassistantImg,
        links: [],
    },
];
---

<section id="projects" class="projects-section">
    <div class="container">
        <h2 class="section-title">
            <span class="bracket"
                >{}
                <span>PROJECTS</span>
                <span class="bracket"></span></span
            >
        </h2>

        <div class="projects-grid">
            {
                projects.map((project) => (
                    <article class="project-card">
                        <div class="card-header">
                            <span
                                class="project-type highlight"
                            >
                                [{project.type}]
                            </span>
                            <div class="header-lines" />
                        </div>

                        <div class="card-content">
                            <div class="project-image-container">
                                <Image
                                    src={project.image}
                                    alt={project.title}
                                    width={600}
                                    height={338}
                                    class="project-img"
                                    loading="lazy"
                                />
                                <div class="overlay" />
                            </div>
                            <h3 class="project-title">{project.title}</h3>
                            <p
                                class="project-desc"
                            >
                                {project.description}
                            </p>

                            <div class="project-tech">
                                {project.tech.map((t) => (
                                    <Icon name={t} class="tech-icon-sm" />
                                ))}
                            </div>

                            <button
                                class="access-btn view-details-btn"
                                data-target={`modal-${project.title.replace(/\s+/g, "-")}`}
                            >
                                <span>
                                    VIEW_DETAILS
                                </span>{" "}
                                <Icon name="mdi:eye" />
                            </button>
                        </div>
                    </article>
                ))
            }
        </div>
    </div>
</section>

</section>

{projects.map((project) => (
    <dialog id={`modal-${project.title.replace(/\s+/g, '-')}`} class="retro-modal">
        <div class="modal-content">
            <button class="close-btn" data-close={project.title.replace(/\s+/g, '-')}>[X]</button>
            <div class="modal-header">
                <h3>{project.title}</h3>
                <div class="modal-lines"></div>
            </div>

            <div class="modal-body">
                <div class="modal-image-container">
                    <Image
                        src={project.image}
                        alt={project.title}
                        width={600}
                        height={400}
                        class="modal-img"
                        loading="lazy"
                    />
                    <div class="scanline-overlay"></div>
                </div>

                <div class="modal-info">
                    <h4>>> SYSTEM_ANALYSIS:</h4>
                    <p>
                        {project.description}
                    </p>

                    <h4>
                        >> DETECTED_TECHNOLOGIES:
                    </h4>
                    <div class="project-tech-modal">
                        {project.tech.map((t) => (
                             <Icon name={t} class="tech-icon-sm" />
                        ))}
                    </div>

                    <div class="modal-actions">
                        {project.links.map((link) => (
                            <a href={link.url} target="_blank" class="retro-btn">
                                <span class="btn-text">
                                    {link.label === "LANDING_REPO" ? "REPO_LANDING" :
                                     link.label === "FRONT_REPO" ? "REPO_FRONTEND" :
                                     link.label === "BACK_REPO" ? "REPO_BACKEND" :
                                     link.label === "LIVE_DEMO" ? "LIVE_DEMO" :
                                     link.label === "APP_REPO" ? "REPO_APP" :
                                     link.label === "FIGMA_DESIGN" ? "FIGMA_DESIGN" : link.label}
                                </span>
                            </a>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    </dialog>
))}

<script>
    import { setupModals } from "../scripts/utils";

    document.addEventListener('astro:page-load', () => {
        setupModals(".view-details-btn", ".close-btn", "dialog.retro-modal");
    });

    // Fallback
    document.addEventListener('DOMContentLoaded', () => {
        setupModals(".view-details-btn", ".close-btn", "dialog.retro-modal");
    });
</script>

<style>
    .projects-section {
        padding: 4rem 0;
    }

    .section-title {
        color: var(--color-secondary);
        text-align: center;
        margin-bottom: 3rem;
        font-size: 2rem;
        word-break: break-word; /* Ensure it breaks if still too long */
    }

    @media (max-width: 768px) {
        .section-title {
            font-size: 1.5rem;
        }
    }

    .projects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
    }

    .project-card {
        background: #0f0f0f;
        border: 1px solid var(--color-border);
        position: relative;
        overflow: hidden;
        transition: transform 0.3s;
        display: flex;
        flex-direction: column;
    }

    .project-card:hover {
        transform: translateY(-5px);
        border-color: var(--color-secondary);
    }

    .card-header {
        background: #1a1a1a;
        padding: 0.5rem 1rem;
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .project-type {
        font-size: 0.7rem;
        color: var(--color-secondary);
        font-weight: bold;
        letter-spacing: 1px;
    }

    .card-content {
        padding: 1.5rem;
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .project-title {
        color: #fff;
        margin-bottom: 1rem;
        font-size: 1rem;
        white-space: nowrap;
        overflow: hidden;
        /* text-overflow: ellipsis; -- removed as requested */
    }

    @media (max-width: 480px) {
        .project-title {
            font-size: 0.9rem; /* Smaller to fit FINANCETRACKER */
        }
        .card-content {
            padding: 1rem; 
        }
    }

    .project-desc {
        color: #aaa;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
        line-height: 1.6;
    }

    .project-tech {
        display: flex;
        gap: 0.8rem;
        margin-bottom: 1.5rem;
    }

    .tech-icon-sm {
        width: 20px;
        height: 20px;
        color: #666;
    }

    .access-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: transparent;
        border: 1px solid var(--color-secondary);
        color: var(--color-secondary);
        font-family: var(--font-heading);
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: auto;
        align-self: flex-start;
    }

    .access-btn:hover {
        background: var(--color-secondary);
        color: #000;
        box-shadow: 0 0 10px var(--color-secondary);
    }

    /* Modal Styles */
    .retro-modal {
        background: transparent;
        border: none;
        padding: 0;
        max-width: 800px;
        width: 95%; /* Slightly wider on mobile default */
        color: var(--color-text);
        backdrop-filter: blur(5px);
        margin: auto; /* Center natively */
    }

    .retro-modal[open] {
        animation: powerOn 0.4s ease-out forwards;
    }

    @keyframes powerOn {
        0% {
            opacity: 0;
            transform: scale(0.95);
            filter: brightness(0.5);
        }
        50% {
            opacity: 1;
            filter: brightness(1.5); /* Flash effect */
        }
        100% {
            opacity: 1;
            transform: scale(1);
            filter: brightness(1);
        }
    }

    .retro-modal::backdrop {
        background: rgba(0, 0, 0, 0.8);
    }

    .modal-content {
        background: #0a0a0a;
        border: 2px solid var(--color-primary);
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
        padding: 2rem;
        position: relative;
    }

    .close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: var(--color-secondary);
        font-family: var(--font-heading);
        font-size: 1.2rem;
        cursor: pointer;
    }

    .close-btn:hover {
        color: #fff;
        text-shadow: 0 0 5px var(--color-secondary);
    }

    .modal-header h3 {
        color: var(--color-primary);
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
    }

    .modal-lines {
        height: 2px;
        background: repeating-linear-gradient(
            90deg,
            var(--color-primary) 0,
            var(--color-primary) 10px,
            transparent 10px,
            transparent 20px
        );
        margin-bottom: 2rem;
    }

    .modal-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .modal-image-container {
        position: relative;
        border: 1px solid var(--color-border);
        height: 250px;
        overflow: hidden;
    }

    .modal-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .modal-info h4 {
        color: var(--color-accent);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .modal-info p {
        margin-bottom: 2rem;
        line-height: 1.6;
    }

    .project-tech-modal {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .modal-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-top: 2rem;
    }

    .retro-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: transparent;
        border: 1px solid var(--color-primary);
        color: var(--color-primary);
        font-family: var(--font-heading);
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .retro-btn:hover {
        background: var(--color-primary);
        color: #000;
        box-shadow: 0 0 10px var(--color-primary);
    }

    @media (max-width: 768px) {
        .modal-body {
            grid-template-columns: 1fr;
        }

        .modal-actions {
            justify-content: center;
        }

        .retro-btn {
            width: 100%;
            justify-content: center;
        }
    }
</style>

<style>
    /* ... existing styles ... */
    
    .project-image-container {
        position: relative;
        overflow: hidden;
        border-radius: 4px;
        margin-bottom: 1rem;
        aspect-ratio: 16/9;
    }

    .project-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .project-card:hover .project-img {
        transform: scale(1.05);
    }

    .overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            to bottom,
            rgba(0,0,0,0) 0%,
            rgba(0,0,0,0.6) 100%
        );
        pointer-events: none;
    }

    .modal-image-container {
        position: relative;
        border: 1px solid var(--color-border);
        height: 300px; /* Taller on desktop */
        overflow: hidden;
        border-radius: 4px;
    }

    .modal-img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Important for modal image too */
    }

    .scanline-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
            0deg,
            rgba(0, 0, 0, 0.1),
            rgba(0, 0, 0, 0.1) 1px,
            transparent 1px,
            transparent 2px
        );
        pointer-events: none;
    }
</style>
